pipeline {
    agent any
    tools {
        maven 'M3'
    }

    stages {
        //stage('scm'){
        //    steps{
        //        git branch: 'master',
        //        credentialsId: 'GitHub username and mdp',
        //        url: 'https://github.com/JeezLF/ITIIP15-DevOps-MurlopsTeam.git'
        //    }
        //}
        stage('Build') {
            steps {
               dir("retwisj"){
                       sh 'mvn -Dmaven.test.failure.ignore clean package'
               }
		sh '/usr/bin/docker build -t retwisj:${BUILD_NUMBER} .'
            }
        }

	stage('Test') {
		steps {
			junit 'retwisj/target/surefire-reports/**/*.xml'
			}
        }

	stage('Scan with Probely') {
      		steps {
        		curl https://api.probely.com/targets/AxtkqTE0v3E-/scan_now/ \
  				-X POST \
  				-H "Content-Type: application/json" \
  				-H "Authorization: JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0ZW5hbnQiOiJwcm9iZWx5IiwidXNlcm5hbWUiOiJ1NGNLTXBFY0xxclEiLCJqdGkiOiIzZ0RXZlJ6RjRvaEoifQ.RmbpTJrIRsNktoGftLagmILDqTd5-hocADrwHp6JbXU"
			def response = sh(script: 'curl https://some-host/some-service/getApi?apikey=someKey', returnStdout: true)
			curl https://api.probely.com/targets/AxtkqTE0v3E-/scans/response.id/ \
  				-X GET \
  				-H "Content-Type: application/json" \
  				-H "Authorization: JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0ZW5hbnQiOiJwcm9iZWx5IiwidXNlcm5hbWUiOiJ1NGNLTXBFY0xxclEiLCJqdGkiOiIzZ0RXZlJ6RjRvaEoifQ.RmbpTJrIRsNktoGftLagmILDqTd5-hocADrwHp6JbXU"
			curl https://api.probely.com/targets/AxtkqTE0v3E-/findings/?scan=response.id&page=1 \
  				-X GET \
  				-H "Content-Type: application/json" \
  				-H "Authorization: JWT eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0ZW5hbnQiOiJwcm9iZWx5IiwidXNlcm5hbWUiOiJ1NGNLTXBFY0xxclEiLCJqdGkiOiIzZ0RXZlJ6RjRvaEoifQ.RmbpTJrIRsNktoGftLagmILDqTd5-hocADrwHp6JbXU"
      			}
    }

         stage('Docker push') {
            steps {
				script {
					docker.withRegistry( '', 'DockerHub' ) {			
                    sh 'docker tag retwisj:${BUILD_NUMBER} luca83000/retwisj:${BUILD_NUMBER}'
                    sh 'docker push luca83000/retwisj:${BUILD_NUMBER}'
				    sh 'pwd'
					sh  '''					
						sed -i -r -e "s/retwisj:.*/retwisj:${BUILD_NUMBER}/g" ../pipelinecd/deploy.yaml
						sed -i -r -e "s/retwisj:.*/retwisj:${BUILD_NUMBER}/g" deploy.yaml							
						'''
				   }
				}
            }
        }
    }
}